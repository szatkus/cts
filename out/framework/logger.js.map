{"version":3,"sources":["../../src/framework/logger.ts"],"names":["SkipTestCase","makeQueryString","extractPublicParams","getStackTrace","now","version","LogMessageWithStack","Error","constructor","name","ex","message","stack","toJSON","m","LogMessageWithoutStack","Logger","record","spec","result","cases","results","push","TestSpecRecorder","asJSON","space","JSON","stringify","undefined","test","params","status","timems","TestCaseRecorder","PassState","pass","start","debug","startTime","logs","state","debugging","finish","endTime","Math","ceil","warn","setState","fail","skipped","skip","threw","max"],"mappings":"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","sourcesContent":["import { SkipTestCase } from './fixture.js';\nimport { TestSpecID } from './id.js';\nimport { ParamSpec } from './params/index.js';\nimport { makeQueryString } from './url_query.js';\nimport { extractPublicParams } from './url_query.js';\nimport { getStackTrace, now } from './util/index.js';\nimport { version } from './version.js';\n\ntype Status = 'running' | 'pass' | 'skip' | 'warn' | 'fail';\nexport interface LiveTestSpecResult {\n  readonly spec: string;\n  readonly cases: LiveTestCaseResult[];\n}\n\nexport interface LiveTestCaseResult {\n  readonly test: string;\n  readonly params: ParamSpec | null;\n  status: Status;\n  logs?: LogMessageWithStack[];\n  timems: number;\n}\n\nclass LogMessageWithStack extends Error {\n  constructor(name: string, ex: Error) {\n    super(ex.message);\n\n    this.name = name;\n    this.stack = ex.stack;\n  }\n\n  toJSON(): string {\n    let m = this.name;\n    if (this.message) {\n      m += ': ' + this.message;\n    }\n    m += '\\n' + getStackTrace(this);\n    return m;\n  }\n}\n\nclass LogMessageWithoutStack extends LogMessageWithStack {\n  toJSON(): string {\n    return this.message;\n  }\n}\n\nexport class Logger {\n  readonly results: LiveTestSpecResult[] = [];\n\n  constructor() {}\n\n  record(spec: TestSpecID): [TestSpecRecorder, LiveTestSpecResult] {\n    const result: LiveTestSpecResult = { spec: makeQueryString(spec), cases: [] };\n    this.results.push(result);\n    return [new TestSpecRecorder(result), result];\n  }\n\n  asJSON(space?: number): string {\n    return JSON.stringify({ version, results: this.results }, undefined, space);\n  }\n}\n\nexport class TestSpecRecorder {\n  private result: LiveTestSpecResult;\n\n  constructor(result: LiveTestSpecResult) {\n    this.result = result;\n  }\n\n  record(test: string, params: ParamSpec | null): [TestCaseRecorder, LiveTestCaseResult] {\n    const result: LiveTestCaseResult = {\n      test,\n      params: params ? extractPublicParams(params) : null,\n      status: 'running',\n      timems: -1,\n    };\n    this.result.cases.push(result);\n    return [new TestCaseRecorder(result), result];\n  }\n}\n\nenum PassState {\n  pass = 0,\n  skip = 1,\n  warn = 2,\n  fail = 3,\n}\n\nexport class TestCaseRecorder {\n  private result: LiveTestCaseResult;\n  private state = PassState.pass;\n  private startTime = -1;\n  private logs: LogMessageWithStack[] = [];\n  private debugging = false;\n\n  constructor(result: LiveTestCaseResult) {\n    this.result = result;\n  }\n\n  start(debug: boolean = false): void {\n    this.startTime = now();\n    this.logs = [];\n    this.state = PassState.pass;\n    this.debugging = debug;\n  }\n\n  finish(): void {\n    if (this.startTime < 0) {\n      throw new Error('finish() before start()');\n    }\n    const endTime = now();\n    // Round to next microsecond to avoid storing useless .xxxx00000000000002 in results.\n    this.result.timems = Math.ceil((endTime - this.startTime) * 1000) / 1000;\n    this.result.status = PassState[this.state] as Status;\n\n    this.result.logs = this.logs;\n    this.debugging = false;\n  }\n\n  debug(ex: Error): void {\n    if (!this.debugging) {\n      return;\n    }\n    this.logs.push(new LogMessageWithoutStack('DEBUG', ex));\n  }\n\n  warn(ex: Error): void {\n    this.setState(PassState.warn);\n    this.logs.push(new LogMessageWithStack('WARN', ex));\n  }\n\n  fail(ex: Error): void {\n    this.setState(PassState.fail);\n    this.logs.push(new LogMessageWithStack('FAIL', ex));\n  }\n\n  skipped(ex: SkipTestCase): void {\n    this.setState(PassState.skip);\n    this.logs.push(new LogMessageWithStack('SKIP', ex));\n  }\n\n  threw(ex: Error): void {\n    if (ex instanceof SkipTestCase) {\n      this.skipped(ex);\n      return;\n    }\n\n    this.setState(PassState.fail);\n    this.logs.push(new LogMessageWithStack('EXCEPTION', ex));\n  }\n\n  private setState(state: PassState): void {\n    this.state = Math.max(this.state, state);\n  }\n}\n"],"file":"logger.js"}